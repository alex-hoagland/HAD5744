---
title: "Lecture 4 Code"
author: "Alex Hoagland"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r header}
### 0. Load the packages we will need for this file ####
library(tidyverse) # load the installed package for each new session of R
library(broom)
library(faux) # Useful package for simulating data
library(modelsummary) # For making regression tables
library(causaldata) # Useful toy data sets
library(here) # Helpful in working with directories and projects

set.seed(03262020) # Setting the seed helps to make random number generators give us the same numbers across machines
################################################################################
```

Throughout, we will follow our case study using the NHIS data, which is publicly available. You can follow these instructions to access this data for other purposes: https://ehsanx.github.io/EpiMethods/accessing5.html. For now, we will just use one year of data.

## Scaling and Weighting Regressors

Let's think about what happens when we adjust experience to be in months instead of years. Then, let's weight the regressions.

```{r mydata}
# load the data
mydata <- read.csv("nhis_data.csv")
names(mydata) # documentation available on IPUMS

# let's do a simple regression with the base controls
# we don't have surgical-level data here, but person-level. Let's just do health
mydata <- mydata %>% mutate(HEALTH = ifelse(HEALTH >= 6, NA, HEALTH))
mydata <- mydata %>% mutate(AGE = ifelse(AGE >= 100, NA, AGE))
hist(mydata$HEALTH) # what does this tell us?
mydata <- mydata %>% mutate(FEM = ifelse(SEX == 2, 1, 0),
                            EMP = ifelse(EMPSTAT == 100, 1, 0),
                            MEDICAID = ifelse(HIMCAIDE == 2, 1, 0),
                            PRIVATE = ifelse(HIPRIVATE == 2, 1, 0))
regdata <- mydata %>% filter(MEDICAID == 1 | PRIVATE == 1) # what are we doing here? why?
replication_reg <- lm(HEALTH ~ MEDICAID + AGE + FEM + EMP, data=regdata)

# what if we measure age in months?
regdata <- regdata %>% mutate(age_m = AGE * 12)
replication_reg2 <- lm(HEALTH ~ MEDICAID + age_m + FEM + EMP, data=regdata)
msummary(list("Base"=replication_reg, "Age in Months"=replication_reg2),
         stars=c('*' = .1, '**' = .05, '***' = .01), fmt=5)

# is there a scaling we would want to do? What if we convert health so that negative coefficients indicated worse health 
regdata <- regdata %>% mutate(HEALTH = (HEALTH * -1)+6)
replication_reg <- lm(HEALTH ~ MEDICAID + AGE + FEM + EMP, data=regdata)

# Now what if we weight using the survey weights ("SAMPWEIGHT")
replication_reg3 <- lm(HEALTH ~ MEDICAID + AGE + FEM + EMP,
                   data=regdata, weights=SAMPWEIGHT)

msummary(list("Base"=replication_reg, "Weighted Regression"=replication_reg3),
         stars=c('*' = .1, '**' = .05, '***' = .01)) # what might we interpret here?
```

## Effect of an outlier in a regression

Even a single outlier can change your regression by a lot! This is why nonlinear transformations can be so useful. This code creates an animation to show the effect of including/excluding a single outlier on a regression:

```{r animate-outliers}
library(gganimate)

# Main data
animatedata <- data.frame(x=rnorm(n=100,mean=5,sd=2))
animatedata <- animatedata %>% mutate(y=-.5*x+rnorm(n=100,mean=0,sd=.25))

# Duplicate each row (for transition in animation)
animatedata <- animatedata %>% bind_rows(animatedata)
animatedata$transition <- 0
animatedata[101:200,]$transition <- 1

# Add (one big) outlier to the second set of data
animatedata[201,] <- c(20,-20,1)

# Scatter plot with outlier
ggplot(animatedata,aes(x=x,y=y)) + geom_point() + theme_classic()

# Scatter plot without outlier
animatedata %>% filter(transition == 0) %>% ggplot(aes(x=x,y=y)) + geom_point() + theme_classic()

# To make animated data, need to duplicate rows for all data points in both states (add/subtract only outlier)

animfig <- ggplot(animatedata,aes(x=x,y=y)) +
  geom_point() +
  geom_smooth(data=animatedata,aes(x=x,y=y),method='lm') +
  # Here comes the gganimate code
  transition_states(
    transition,
    transition_length = 1,
    state_length = 1
  ) +
  enter_fade() +
  exit_shrink() +
  ease_aes('linear') +
  theme_classic()
animate(animfig)
anim_save(filename=here("RegressionOutlier.gif"),animation=animfig)
```

## Transformed Models

What kinds of variables would we want to transform? How does the model change? 

```{r log-transform}
# lm(HEALTH ~ MEDICAID + AGE + FEM + EMP)
# should we transform any of these RHS variables? 

# what about the LHS variable
logreg <- lm(log(HEALTH) ~ MEDICAID + AGE + FEM + EMP,
                   data=regdata, weights=SAMPWEIGHT)

msummary(list("Levels"=replication_reg3, "Log(Outcome)"=logreg),
         stars=c('*' = .1, '**' = .05, '***' = .01)) # how do we interpret this? 

hist(log(mydata$HEALTH)) # note: why are we doing this? 

# are there RHS variables we could include that should be transformed?
# what about the LHS variable
logreg2 <- lm(log(HEALTH) ~ MEDICAID + AGE + FEM + EMP + log(HOURSWRK+1),
                   data=regdata, weights=SAMPWEIGHT)

msummary(list("(1)"=logreg, "(2)"=logreg2),
         stars=c('*' = .1, '**' = .05, '***' = .01)) # how do we interpret this? 
```

## Interaction Terms

Suppose that we are interested in whether the relationship between Medicaid coverage and health differ across groups. What kind of groups might we care about? 

```{r interactions}
# let's pick a group
names(mydata)

# this example stratifies across citizens but we can pick any of the others 
regdata <- regdata %>% mutate(uscitizen = ifelse(CITIZEN == 2, 1, 0))

# Basic example
logreg2 <- lm(log(HEALTH) ~ MEDICAID + uscitizen + MEDICAID:uscitizen + AGE + FEM + EMP + log(HOURSWRK+1),
                   data=regdata, weights=SAMPWEIGHT)

msummary(list("Base Model (logs)"=logreg, "Interaction Model (logs)"=logreg2),
         stars=c('*' = .1, '**' = .05, '***' = .01)) # how do we interpret this?

# What if we had left out the main effect?
logreg2_wrong <- lm(log(HEALTH) ~ MEDICAID:uscitizen + AGE + FEM + EMP + log(HOURSWRK+1),
                   data=regdata, weights=SAMPWEIGHT)

msummary(list("Base Model (logs)"=logreg, "Interaction Model (logs)"=logreg2, "Interaction Model (bad!)"=logreg2_wrong),
         stars=c('*' = .1, '**' = .05, '***' = .01)) # how do we interpret this?
```

## Polynomial Models

What if we think:

-   Age has a nonlinear effect on health (why might this be true?)

Let's model this nonlinearity by including a squared term in the regression

```{r nonlinear}
regdata %>% group_by(AGE) %>% summarize(HEALTH=mean(HEALTH,na.rm=T)) %>% 
  ggplot(aes(x=AGE,y=HEALTH)) + geom_point() + theme_minimal() +
  labs(x="Age (Years)",y="Average HEALTH") # what does this show? Do we need a nonlinear effect? 

# add a squared term for age
regdata <- regdata %>% mutate(age2 = AGE*AGE)
logreg2 <- lm(log(HEALTH) ~ MEDICAID + AGE + age2 + FEM + EMP + log(HOURSWRK+1),
                   data=regdata, weights=SAMPWEIGHT)

msummary(list("Base Model (logs)"=logreg, "Nonlinear Model (logs)"=logreg2),
         stars=c('*' = .1, '**' = .05, '***' = .01)) # how do we interpret this?
```

## Standard Errors

### Heteroskedasticity

Let's implement robust standard errors in our regressions. This can actually be done easily in `msummary`!

```{r robust-ses}
# Same model with robust standard errors
msummary(list("Base"=logreg, "Robust SEs"=logreg),
         stars=c('*' = .1, '**' = .05, '***' = .01), 
         vcov=c("classical","robust")) # how do we interpret this?
```

### Clustering

Now, suppose that we have data on geography (US Regions). What if Medicaid policy differed across these regions in ways that are correlated with health? Why might this be true?

```{r clustered-ses}
msummary(list("Base"=logreg, "Robust SEs"=logreg, "Clustered SEs"=logreg),
         stars=c('*' = .1, '**' = .05, '***' = .01), 
         vcov=c("classical","robust", ~REGION)) # how do we interpret this?
```

### Appendix: Bootstrapping standard errors

For whatever reason, you may need to bootstrap your standard errors. This is a sample code for how you might do that.

```{r bootstrap}
numiter <- 1000 # Number of times you want to sample
sizesample=nrow(mydata) # Size of the sample you want to take

# Create a place to store the coefficients
allbetas <- rep(NA,numiter)

# Run the loop
for (i in 1:numiter) {
  sampledata <- mydata[sample(nrow(mydata), sizesample,replace=T), ]
  samplemodel <- lm(lwage ~ educ + exper + black + married + nearc4 + educ:black + exper:black, data=sampledata)
  allbetas[i] <- samplemodel$coefficients[2] # Effect of education on lwage
}

# Represent graphically
allbetas <- tibble(allbetas)
ggplot(allbetas,aes(x=allbetas)) + geom_histogram(fill='gray',color="black") + theme_minimal() +
  labs(x="Estimated Betas",y="Count") + geom_vline(xintercept=0.077,color="red",size=2)

sd(allbetas$allbetas) # This gives us a bootstrapped SE remarkably similar to the regression approach
```

## Package Citations

```{r, include=FALSE}
print("=============================Works Cited=============================")
loadedNamespaces() %>%
map(citation) %>%
print(style = "text") # Adds citations for each package to end of .rmd file

knitr::write_bib(file = 'packages.bib') # Constructs a citation file for all packages used in this lecture.

# DON'T FORGET TO CITE YOUR PACKAGES IN YOUR PAPERS/ASSIGNMENTS.
```
